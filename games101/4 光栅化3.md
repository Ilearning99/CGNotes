# 光栅化(反走样和深度缓存)

## 反走样

### 采样在计算机图形学中无处不在

- 光栅化 在2D位置采样
- 照片 图像传感器的感光平面
- 视频 采样时间

### 图形学中采样的**Artifacts** (错误/不准确/不希望看到的结果)

- Artifacts是图形学中的黑话，中文翻译叫瑕疵，但这个翻译并不准确

- Artifacts常见的种类
  - 锯齿，圆形图案的边缘
  - 摩尔纹 (Moire Patterns)
    - 一幅画，随机采样奇数行和列，再放大到原来的大小，就会产生摩尔纹
  - 车轮效应
    - 在路上，看行驶的汽车，常会觉得车轮是在逆时针旋转
  
- Artifacts的产生都是由于采样

  - 锯齿 空间上的采样
  - 摩尔纹 图片上的降采样
  - 车轮效应 时间上的采样

- Artifacts的深层次原因

  **信号变化太快，采样太慢**

### 反走样的基本想法-采样前进行模糊或者滤波

- 光栅化-对空间中点采样
  - 光栅化中的锯齿是由于每个像素的颜色是纯红或者纯白

- 光栅化-反走样采样
  - 步骤：图片->模糊化(滤波)->采样
  - 主要思想：去除高于奈奎斯特频率(Nyquist)的信号
  - 通俗：边缘像素的颜色值是中间值

### 为什么低采样频率会造成锯齿

#### 频域

- 正弦波和余弦波
  $$
  f(x) = cos2\pi x \\
  f(x) = sin2\pi x \\
  $$
  
- 一般化的余弦函数
  $$
  f(x) = cos2\pi fx
  $$

  - 参数$f$表示频率，表示变化速度

  - 定义$T$表示周期
    $$
    f=\frac{1}{T}
    $$
    
  - 不同的正弦和余弦函数有不同的频率
  
- 傅立叶级数展开

  - 任何函数都可以写成一系列正弦函数和余弦函数的线性组合加常数项
    $$
    f(x) = \frac{A}{2} + \frac{2Acos(\omega x)}{\pi} - \frac{2Acos(3\omega x)}{3\pi} + \frac{2Acos(5\omega x)}{5\pi} - \frac{2Acos(7 \omega x)}{7\pi} + \cdots
    $$
  
  - 一个函数，可以分解为频率从低到高的三角函数
  
- 傅立叶变换 (Fourier transform)

  - 一个函数$f(x)$通过傅立叶变换变成另一个函数$F(\omega)$
    $$
    F(\omega) = \int_{-\infty}^{\infty}f(x)e^{-2\pi i \omega x} dx
    $$

  - 逆傅立叶变换
    $$
    f(x) = \int_{-\infty}^{\infty}F(\omega)e^{2\pi i \omega x}d \omega
    $$

  - 将函数显示成不同的频率段，将信号从时域变到频域

#### 走样的原因

- 越高频率的函数，需要越快采样
  - 对于低频率的信号，采样速度合适，采样结果可以产生合理的重构结果。
  - 对于高频率的信号，采样不足够，采样结果看上去就像来自于一个低频率信号，这种采样结果，只能重构出一个低频率信号，和原始信号差别很大。
  - 两个不同频率的信号，如果在当前的采样频率下，采样结果类似，就被称作“走样”。



### 过滤=去除特定频率的内容

- 图像

  - 空间上不同位置看做空域，通过傅立叶变换，变到频率空间
  - 频谱，图片转换到频率空间形成的图像，中间是低频频率，边缘是高频频率，亮度表示频率存在多少
  - 自然图片都是低频信息
  - 水平中心线和垂直中心线特别量，因为图片基本没有周期信息，(?周期性边界条件)

- 过滤低频信号 (边缘化)

  - 高通滤波器

- 过滤高频信号 (模糊化)

  - 低通滤波器

- 同时去掉高频和低频只保留中频段

  

### 过滤=卷积(=平均化)

#### 卷积(示例)

- 信号：1,3,5,3,7,1,3,8,6,4
- 卷积核：1/4,1/2,1/4
- 结果：#,3,4,...

#### 卷积定理

时域上两个信号的卷积，是频域上两个信号乘积。

- 方法一
  - 直接在空域上进行卷积
- 方法二
  - 变换到频域(傅立叶变换)
  - 乘卷积核的傅立叶变换
  - 返回到空域(逆傅立叶变换)

#### 滤波器示例

- box filter(盒子滤波器，$3 \times 3$)
  
  - 低通滤波器
  - 如果盒子变大($4 \times 4$)，频域会更小
  
  $$
  \frac{1}{9} \cdot
  \begin{pmatrix}
  1 & 1 & 1 \\
  1 & 1 & 1 \\
  1 & 1 & 1
  \end{pmatrix}
  $$
  

### 采样 = 重复频率内容

- 原始时域函数 $X_{a}(t)$，对应频域频谱$X_a(f)$
- 采样函数
  - 时域空间，周期性的冲击函数 $P_{\sigma}(t)$
  - 频域空间，周期性的冲击函数$P_{\sigma}(f)$
- 采样结果函数
  - 时域空间，一系列离散点$S(t)$，时域上的乘积
  - 频域空间，根据卷积定理，时域上的乘积等于频域上的卷积，相当于频谱拷贝多遍

### 从频域上看走样=采样后结果函数，频谱有重叠

- 密集采样，对应的频域冲击函数，间隔更宽，采样后，原始函数频谱没有重叠。
- 稀疏采样，对应的频域冲击函数，间隔更窄，采样后，原始函数频谱有重叠，原始函数有走样。

### 如何解决走样的问题

- 选择一：提高采样频率
  - 最终提升在傅里叶频率空间，不同频谱副本的间隔
  - 更高分辨率的显示器，传感器，帧缓存等
  - 缺点：成本很高，本质就是更高分辨率
- 选择二：反走样
  - 在采样前，通过变换，将傅里叶频谱变得更窄
  - 例如，先过滤掉高频信息，再采样，这样傅里叶屏幕会变窄，采样频谱更难形成重叠造成走样。

### 反走样采样

- 正常采样，每个像素点是二值，要么在三角形内，要么在三角形外
- 先过滤再采样，边缘附近的像素点，像素值会是一个中间值

### 预处理方式

- 采用盒子滤波器，进行低通滤波
  - 实际做法，对原始图片卷积，相当于将一个像素上的像素值，看作所有该像素上所有颜色的平均，不再是二值
  - 具体地，这个像素的像素值，等于像素中在三角形中部分的面积/像素面积
- 在像素中心点采样

### 通过超采样进行反走样处理

- 方法MSAA
- 在一个像素内，采样多个点，平均这些点的值，作为一个像素点的值，近似盒子过滤的结果。
- 超采样，在一个像素内，采样$N \times N$个点
- 但是超采样意味着更多的资源消耗

#### 其他反走样方法

- FXAA(Fast Approximate AA) 对结果，进行反走样操作
- TAA(Temporal AA) 在游戏中，累积时间上不同帧的结果
- DLSS(Deep Learning Super Sampling) 基于深度学习的超采样方法，所有靠猜的，都可以使用深度学习方法。



